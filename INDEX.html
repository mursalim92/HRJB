<script>
    async function loadData() {
        const SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuJPtEwzwo9O3MjCKYYQBbz_rGkod8Bjm4G13B4BwhD3RlmdP2WwBXK9Smy0mrlfdNvJtDHFCi-P9Y/pub?output=csv";
        const nik = document.getElementById("nikInput").value.trim();
        const resultDiv = document.getElementById("resultContainer");
        
        // Validasi input
        if (!nik) {
            showError("Silakan masukkan NIK karyawan");
            return;
        }
        
        // Tampilkan loading
        resultDiv.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
            </div>
        `;
        
        try {
            // Ambil data dari Google Sheets
            const response = await fetch(SPREADSHEET_URL);
            
            if (!response.ok) {
                throw new Error(`Gagal mengambil data. Status: ${response.status}`);
            }
            
            const csvData = await response.text();
            const rows = csvData.split("\n");
            const header = rows[0].split(",");

            // Debug: Lihat struktur header
            console.log("Header Kolom:", header);

            // Cari index kolom AH sampai BB
            const startCol = header.findIndex(col => col.trim() === "AH");
            if (startCol === -1) throw new Error("Kolom AH tidak ditemukan");

            // Buat mapping kolom ke tanggal (AH=11, AI=12, ..., BB=10)
            const dateColumns = [];
            const dateLabels = [];
            
            // Tanggal 11-31 (kolom AH-AR)
            for (let i = 0; i < 31; i++) {
                dateColumns.push(startCol + i);
                dateLabels.push(`Tgl ${i+11}`);
            }
            
            // Tanggal 1-10 bulan depan (kolom AS-BB)
            for (let i = 31; i < 41; i++) {
                dateColumns.push(startCol + i);
                dateLabels.push(`Tgl ${i-30}`);
            }

            // Cari data karyawan
            const karyawan = rows.find(row => {
                const rowData = row.split(",");
                return rowData[0].trim() === nik;
            });

            if (karyawan) {
                const data = karyawan.split(",");
                const nama = data[1] || '-';
                const jabatan = data[2] || '-';
                const departemen = data[3] || '-';
                
                // Generate inisial untuk avatar
                const inisial = nama.split(" ").map(n => n[0]).join("").toUpperCase();
                
                // Buat HTML untuk menampilkan data
                resultDiv.innerHTML = `
                    <div class="employee-card">
                        <div class="employee-header">
                            <div class="employee-avatar">${inisial}</div>
                            <div class="employee-info">
                                <h2>${nama}</h2>
                                <div class="employee-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-id-badge"></i>
                                        <span>${nik}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-briefcase"></i>
                                        <span>${jabatan}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-building"></i>
                                        <span>${departemen}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="attendance-table">
                                <thead>
                                    <tr>
                                        ${dateLabels.map(label => `<th>${label}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${dateColumns.map(col => {
                                            if (col >= data.length) return '<td>-</td>';
                                            
                                            const status = data[col].trim().toLowerCase();
                                            let className = '';
                                            let displayText = data[col];
                                            
                                            if (status.includes('hadir')) {
                                                className = 'status-hadir';
                                                if (status.includes('jam')) {
                                                    displayText = 'Hadir';
                                                    className += ' status-lembur';
                                                }
                                            } else if (status.includes('izin')) {
                                                className = 'status-izin';
                                            } else if (status.includes('alpha')) {
                                                className = 'status-alpha';
                                            }
                                            
                                            return `<td class="${className}">${displayText}</td>`;
                                        }).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                showError("Data karyawan tidak ditemukan");
            }
        } catch (error) {
            console.error("Error:", error);
            showError(`Terjadi kesalahan: ${error.message}`);
        }
    }
    
    function showError(message) {
        const resultDiv = document.getElementById("resultContainer");
        resultDiv.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>${message}</p>
            </div>
        `;
    }
    
    // Tambahkan event listener untuk tombol enter
    document.getElementById("nikInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            loadData();
        }
    });
</script>
